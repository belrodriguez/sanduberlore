<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sanduber Lore</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/favicon.ico">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon-180.png">
  <style>
    /* Fixed frame */
    #frame {
      width: 1500px;
      height: 1792px;
      overflow: hidden;
      position: relative;
      margin: auto;
      border: 2px solid black;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: black;
    }
    /* Collage container */
    #collage { position: relative; width: 100%; height: 100%; }
    /* Image layers */
    .layer {
      position: absolute;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }
    /* Focus effect */
    .focused { transform: scale(1.1); }
    /* Popup overlay */
    #popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    /* Popup box */
    .popup {
      background: white;
      color: black;
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      width: 80%;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      font-family: "Special Elite", serif;
      line-height: 1.5;
    }
    /* YouTube Container */
    #youtube-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      background: black;
      padding: 10px;
    }
    #youtube-container iframe {
      width: 560px;
      height: 315px;
    }
    /* Local Video Container */
    #video-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      background: black;
      padding: 10px;
    }
    #video-container video {
      width: 560px;
      height: 315px;
    }
    /* Body */
    body { background-color: black; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="frame">
    <div id="collage"></div>
  </div>
  <!-- Popup overlay -->
  <div id="popup-overlay">
    <div id="popup" class="popup"></div>
  </div>
  <div id="youtube-container">
    <button id="close-youtube" style="position:absolute; top:5px; right:5px;">X</button>
    <iframe id="youtube-player" frameborder="0" allowfullscreen></iframe>
    <button id="open-youtube" style="display:none; margin-top:10px;">Watch on YouTube</button>
  </div>
  <div id="video-container">
    <button id="close-video" style="position:absolute; top:5px; right:5px;">X</button>
    <video id="local-video" controls></video>
  </div>

  <script>
    let audioPlayers = {};
    let youtubeTimeout, youtubePlayer, youtubeContainer, openYouTubeButton;
    let localVideo, videoContainer, popupOverlay, popup;

    // Returns true if the pixel at the click position is fully transparent.
    function isTransparent(e, img) {
      if (!img.complete || img.naturalWidth === 0) return false;
      const canvas = document.createElement("canvas");
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      const rect = img.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (img.naturalWidth / rect.width);
      const y = (e.clientY - rect.top) * (img.naturalHeight / rect.height);
      const pixel = ctx.getImageData(x, y, 1, 1).data;
      return pixel[3] === 0;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const collage = document.getElementById("collage");
      popupOverlay = document.getElementById("popup-overlay");
      popup = document.getElementById("popup");
      youtubeContainer = document.getElementById("youtube-container");
      youtubePlayer = document.getElementById("youtube-player");
      openYouTubeButton = document.getElementById("open-youtube");
      videoContainer = document.getElementById("video-container");
      localVideo = document.getElementById("local-video");

      document.getElementById("close-youtube").addEventListener("click", () => {
        youtubeContainer.style.display = "none";
        youtubePlayer.src = "";
        clearTimeout(youtubeTimeout);
      });
      document.getElementById("close-video").addEventListener("click", () => {
        videoContainer.style.display = "none";
        localVideo.pause();
        localVideo.src = "";
      });
      openYouTubeButton.addEventListener("click", () => {
        window.open(openYouTubeButton.dataset.url, "_blank");
      });
      popupOverlay.addEventListener("click", (e) => {
        if (e.target === popupOverlay) {
          popupOverlay.style.display = "none";
          popup.innerHTML = "";
        }
      });

      try {
        const response = await fetch("images.json");
        const images = await response.json();
        images.forEach(image => {
          const img = document.createElement("img");
          img.src = `images/${image.filename}`;
          img.classList.add("layer");
          img.style.left = `${image.x}px`;
          img.style.top = `${image.y}px`;
          img.style.width = `${image.width}px`;
          img.style.height = `${image.height}px`;
          if (image.opacity !== undefined) img.style.opacity = image.opacity;
          if (image.visible === false) img.style.display = "none";
          // Store image data for later reference.
          img.myData = image;
          collage.appendChild(img);
        });
      } catch (error) {
        console.error("Error loading images:", error);
      }

      // Use a single click handler on the collage to determine which image was actually clicked.
      collage.addEventListener("click", (e) => {
        const elems = document.elementsFromPoint(e.clientX, e.clientY);
        for (let elem of elems) {
          if (elem.tagName.toLowerCase() === "img" && elem.classList.contains("layer")) {
            if (!isTransparent(e, elem)) {
              const data = elem.myData;
              if (data) {
                if (data.zoom) {
                  if (elem.classList.contains("focused")) {
                    elem.classList.remove("focused");
                  } else {
                    document.querySelectorAll(".layer").forEach(i => i.classList.remove("focused"));
                    elem.classList.add("focused");
                  }
                }
                handleInteraction(data, elem);
              }
              break;
            }
          }
        }
      });
    });

    function convertToSeconds(timeStr) {
      if (!timeStr) return 0;
      const parts = timeStr.split(":").map(Number);
      if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
      if (parts.length === 2) return parts[0] * 60 + parts[1];
      return Number(timeStr);
    }

    function handleInteraction(image, clickedImg) {
      if (!image.interaction) return;
      const { type, content, file, videoId, startTime, endTime, 
              popupTitle, popupTitleFont, popupTitleSize, 
              popupBody, popupBodyFont, popupBodySize, 
              popupImage, popupMessage, url } = image.interaction;
      
      if (type === "text") {
        popup.innerHTML = "";
        const container = document.createElement("div");
        container.style.display = "flex";
        container.style.flexDirection = "column";
        container.style.alignItems = "center";
        container.style.textAlign = "center";
        const imgContainer = document.createElement("div");
        imgContainer.style.width = "50%";
        imgContainer.style.height = "50%";
        imgContainer.style.marginBottom = "20px";
        const refImg = document.createElement("img");
        refImg.src = popupImage ? `images/${popupImage}` : clickedImg.src;
        refImg.style.width = "50%";
        refImg.style.height = "50%";
        refImg.style.objectFit = "contain";
        imgContainer.appendChild(refImg);
        container.appendChild(imgContainer);
        const textContainer = document.createElement("div");
        if (popupTitle) {
          const titleElem = document.createElement("h2");
          titleElem.innerText = popupTitle;
          if (popupTitleFont) titleElem.style.fontFamily = popupTitleFont;
          if (popupTitleSize) titleElem.style.fontSize = popupTitleSize;
          titleElem.style.margin = "0 0 10px 0";
          textContainer.appendChild(titleElem);
        }
        if (popupBody) {
          const bodyElem = document.createElement("p");
          bodyElem.innerHTML = popupBody;
          if (popupBodyFont) bodyElem.style.fontFamily = popupBodyFont;
          if (popupBodySize) bodyElem.style.fontSize = popupBodySize;
          bodyElem.style.margin = "0";
          textContainer.appendChild(bodyElem);
        }
        if (!popupTitle && !popupBody) {
          const fallbackElem = document.createElement("div");
          fallbackElem.innerHTML = popupMessage ? popupMessage : content;
          textContainer.appendChild(fallbackElem);
        }
        container.appendChild(textContainer);
        popup.appendChild(container);
        popupOverlay.style.display = "flex";
      } else if (type === "audio") {
        if (!audioPlayers[file]) audioPlayers[file] = new Audio(`audio/${file}`);
        const audio = audioPlayers[file];
        if (!audio.paused) {
          audio.pause();
          audio.currentTime = 0;
        } else {
          audio.play();
        }
      } else if (type === "youtube") {
        const startSec = convertToSeconds(startTime);
        youtubePlayer.src = `https://www.youtube.com/embed/${videoId}?start=${startSec}&autoplay=1&enablejsapi=1`;
        youtubeContainer.style.display = "block";
        if (endTime) {
          const duration = (convertToSeconds(endTime) - startSec) * 1000;
          youtubeTimeout = setTimeout(() => {
            youtubeContainer.style.display = "none";
            youtubePlayer.src = "";
          }, duration);
        }
      } else if (type === "video") {
        localVideo.src = `videos/${file}`;
        videoContainer.style.display = "block";
        localVideo.play();
      } else if (type === "redirect") {
        window.open(url, "_blank");
      }
    }
  </script>
</body>
</html>
